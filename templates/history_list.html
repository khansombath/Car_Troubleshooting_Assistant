{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 mb-0">Diagnosis History</h2>
    <div>
        <a class="btn btn-primary" href="{{ url_for('infer') }}">
            <span class="d-none d-sm-inline">‚Üê Run New Diagnosis</span>
            <span class="d-sm-none">‚Üê New</span>
        </a>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover mb-0">
        <thead>
            <tr>
                <th class="d-none d-md-table-cell">ID</th>
                <th>Timestamp</th>
                <th class="d-none d-sm-table-cell">Top Conclusion</th>
                <th>Confidence</th>
                <th style="min-width: 120px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for it in items %}
            <tr>
                <!-- ID Column - hidden on mobile -->
                <td class="d-none d-md-table-cell">
                    <strong>{{ loop.index }}</strong>
                </td>
                
                <!-- Timestamp Column -->
                <td>
                    <!-- Show ID on mobile -->
                    <div class="d-md-none mb-1">
                        <small class="text-muted">ID:</small>
                        <strong>{{ loop.index }}</strong>
                    </div>
                    <div class="text-nowrap">
                        {{ it.formatted_timestamp }}
                    </div>
                </td>
                
                <!-- Top Conclusion Column - hidden on mobile -->
                <td class="d-none d-sm-table-cell">
                    {% if it.top_conclusion %}
                        <span class="text-truncate d-inline-block" style="max-width: 200px;" 
                              title="{{ it.top_conclusion | replace('_',' ') | title }}">
                            {{ it.top_conclusion | replace('_',' ') | title }}
                        </span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                
                <!-- Confidence Column -->
                <td>
                    {% if it.top_confidence is not none %}
                        {% if it.top_confidence >= 80 %}
                            <span class="badge bg-success">{{ it.top_confidence }}%</span>
                        {% elif it.top_confidence >= 50 %}
                            <span class="badge bg-warning text-dark">{{ it.top_confidence }}%</span>
                        {% else %}
                            <span class="badge bg-danger">{{ it.top_confidence }}%</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">-</span>
                    {% endif %}
                    
                    <!-- Show conclusion on mobile -->
                    <div class="d-sm-none mt-1 small">
                        {% if it.top_conclusion %}
                            <span class="text-truncate d-block" 
                                  title="{{ it.top_conclusion | replace('_',' ') | title }}">
                                {{ it.top_conclusion | replace('_',' ') | title }}
                            </span>
                        {% else %}
                            <span class="text-muted">No conclusion</span>
                        {% endif %}
                    </div>
                </td>
                
                <!-- Actions Column -->
                <td>
                    <div class="d-flex flex-nowrap gap-1">
                        <a href="{{ url_for('history_detail', hid=it.id) }}" 
                           class="btn btn-sm btn-outline-info flex-fill">
                            <span class="d-none d-sm-inline">View</span>
                            <span class="d-sm-none">üëÅÔ∏è</span>
                        </a>
                        <form action="{{ url_for('delete_history', hid=it.id) }}" 
                              method="post" 
                              class="d-inline flex-fill">
                            <button type="submit" 
                                    class="btn btn-sm btn-outline-danger w-100"
                                    onclick="return confirm('Delete this diagnosis?')">
                                <span class="d-none d-sm-inline">Delete</span>
                                <span class="d-sm-none">üóëÔ∏è</span>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% if not items %}
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    No history yet. Run a diagnosis to generate history.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<style>
    /* Responsive adjustments */
    @media (max-width: 575.98px) {
        .table-responsive {
            border: 0;
            margin: 0 -1rem;
            width: calc(100% + 2rem);
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .btn-sm {
            padding: 0.25rem 0.4rem;
            font-size: 0.8rem;
        }
        
        td, th {
            padding: 0.75rem 0.5rem !important;
        }
        
        /* Make badges smaller on mobile */
        .badge {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }
    }
    
    @media (max-width: 767.98px) {
        .table td, .table th {
            padding: 0.75rem;
        }
        
        /* Adjust column widths */
        td:nth-child(2), /* Timestamp */
        th:nth-child(2) {
            min-width: 120px;
        }
        
        td:nth-child(4), /* Confidence */
        th:nth-child(4) {
            min-width: 80px;
        }
    }
    
    @media (min-width: 768px) and (max-width: 991.98px) {
        /* Tablet optimizations */
        td:nth-child(2), /* Timestamp */
        th:nth-child(2) {
            min-width: 140px;
        }
        
        td:nth-child(3), /* Top Conclusion */
        th:nth-child(3) {
            max-width: 180px;
        }
    }
    
    /* Ensure text doesn't overflow */
    .text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Better hover effects */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    /* Ensure buttons are equally sized */
    .flex-fill {
        flex: 1 1 0;
        min-width: 0;
    }
    
    /* Make confidence badges visually distinct */
    .badge.bg-success { background-color: #198754 !important; }
    .badge.bg-warning { background-color: #ffc107 !important; }
    .badge.bg-danger { background-color: #dc3545 !important; }
    .badge.bg-secondary { background-color: #6c757d !important; }
</style>

{% endblock %}